{% extends "layout.html" %}
{% block body %}

	<!-- Local files -->
	<script src="{{ url_for('static', filename='schema_diagram.js') }}"></script>
	<script src="{{ url_for('static', filename='diagram_helpers.js') }}"></script>
	<script type="text/javascript">
		var entityName = {{ entity_name | tojson }}
		var diagramData = {{ diagram_data | tojson }}
		var tables = {{ tables | tojson }};

		window.onload = function() {
			initDiagram('schema-diagram', diagramData, editableHeader=true);

			document.getElementById('save-layout-button').onclick = function() {
				saveDiagram("{{ request.path }}");
			}

			document.getElementById('expand-button').onclick = function() {
				expandSelection();
			}

			document.getElementById('download-full-diagram').onclick = function() {
				exportFullDiagram("{{ project_name }}" + ".png");
			}

			document.getElementById('download-visible-diagram').onclick = function() {
				exportVisibleDiagram("{{ project_name }}" + ".png");
			}

			var layoutDropdown = document.getElementById('layout');
			bindLayoutDropdown(layoutDropdown);
		}
		$(function() {
			$(".expand").on( "click", function(evt) {
				if(evt.target.tagName === "BUTTON") {
					return;
				} else {
					$(this).next().next().slideToggle(200);
					var $expand = $(this).find(">:first-child");

					if($expand.text() == "+") {
						$expand.text("-");
					} else {
						$expand.text("+");
					}
				}
			});
		});
		function visibility(button, key) {
			if(button.childNodes[1].innerHTML == 'visibility') {
				setNodeVisibility(key, false);
				button.childNodes[1].innerHTML = 'visibility_off';
				console.log(button);
			}
			else {
				setNodeVisibility(key, true);
				button.childNodes[1].innerHTML = 'visibility';
				console.log("VISIBLE");
			}
		}
		function attributeVisibility(button, name, key) {
			if(button.childNodes[1].innerHTML == 'visibility') {
				setRowVisibility(key, name, false);
				button.childNodes[1].innerHTML = 'visibility_off';
				console.log(button);
			}
			else {
				setRowVisibility(key, name, true);
				button.childNodes[1].innerHTML = 'visibility';
				console.log("VISIBLE");
			}			
		}		
	</script>
		
	<div class="container">

		<nav class="navbar" style="margin-bottom: 0">
			<div class="container-fluid">
				<button class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored" style="float: left; margin-right: 30px" onclick="window.location.href = '{{ url_for('abstract_diagram', project_id=project_id) }}' ">
  					<i class="material-icons">keyboard_backspace</i>
				</button>
				<div class="navbar-header">
        			<div class="navbar-brand">{{ entity_name }}</div>
      			</div>
				<ul class="nav navbar-nav navbar-right">
					<li><a href="#" id='save-layout-button'>Save Layout</a></li>
					<li><a href="#" id='expand-button'>Expand</a></li>
					<li class="dropdown">
						<select id="layout">
							<option value="directed">Force Directed</option>
							<option value="circular">Circular</option>
							<option value="grid">Grid</option>
							<option value="digraph">Layered Digraph</option>
						</select>
					</li>
					<li class="dropdown">
			            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="glyphicon glyphicon-save"></i> Download<span class="caret"></span></a>
			            <ul class="dropdown-menu">
			                <li><a href="#" id='download-full-diagram'>Full Diagram</a></li>
			                <li><a href="#" id='download-visible-diagram'>Visible Diagram</a></li>
			            </ul>
			        </li>
				</ul>
			</div>
		</nav>

		<div class="row" style="display: inline;">
			<div class="col-md-3" style="padding: 0;">
				<div style="height:400px; overflow: scroll; border: 1px solid black;">
					<div id="integration-list" style="width: 100%;">
						<ul>
							{% for table in tables %}
								<li>
									<table>
										<tr>
											<td>
												{% if table['visible'] == true %}
													<button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" onclick="visibility(this, {{ table['key'] }})">
														<i class="material-icons">visibility</i>
													</button>
												{% else %}
													<button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" onclick="visibility(this, {{ table['key'] }})">
														<i class="material-icons">visibility_off</i>
													</button>
												{% endif %}
											</td>
											<td>
												<div>
													<h2>
														{{ table['name'] }}
													</h2>
												</div>
											</td>
										</tr>
										<a class="expand" style="margin-right: 20px">
											<div class="right-arrow">+</div>
										</a>
									</table>

									<div class="detail">
										<div id="right">
											<div id="sup">
												<span>
													<table>
														{% for key in table['primary_keys'] %}
															<tr>
																<td>
																	{% if key['visible'] == true %}
																		<button class="mdl-button mdl-js-button mdl-js-ripple-effect" onclick="attributeVisibility(this, '{{ key['name'] }}', {{ table['key'] }})">
																			<i class="material-icons">visibility</i>
																		</button>
																	{% else %}
																		<button class="mdl-button mdl-js-button mdl-js-ripple-effect" onclick="attributeVisibility(this, '{{ key['name'] }}', {{ table['key'] }})">
																			<i class="material-icons">visibility_off</i>
																		</button>
																	{% endif %}
																	
																</td>
																<td>{{ key['name'] }}</td>
															</tr>
														{% endfor %}
														{% for attribute in table['attributes'] %}
															<tr>
																<td>
																	{% if attribute['visible'] == true %}
																		<button class="mdl-button mdl-js-button mdl-js-ripple-effect" onclick="attributeVisibility(this, '{{ attribute['name'] }}', {{ table['key'] }})">
																			<i class="material-icons">visibility</i>
																		</button>
																	{% else %}
																		<button class="mdl-button mdl-js-button mdl-js-ripple-effect" onclick="attributeVisibility(this, '{{ attribute['name'] }}', {{ table['key'] }})">
																			<i class="material-icons">visibility_off</i>
																		</button>
																	{% endif %}
																	
																</td>
																<td>{{ attribute['name'] }}</td>
															</tr>
														{% endfor %}
														{% for fkey in table['foreign_keys'] %}
															<tr>
																<td>
																	{% if fkey['visible'] == true %}
																		<button class="mdl-button mdl-js-button mdl-js-ripple-effect" onclick="attributeVisibility(this, '{{ fkey['name'] }}', {{ table['key'] }})">
																			<i class="material-icons">visibility</i>
																		</button>
																	{% else %}
																		<button class="mdl-button mdl-js-button mdl-js-ripple-effect" onclick="attributeVisibility(this, '{{ fkey['name'] }}', {{ table['key'] }})">
																			<i class="material-icons">visibility_off</i>
																		</button>
																	{% endif %}
																	
																</td>
																<td>{{ fkey['name'] }}</td>
															</tr>
														{% endfor %}
													</table>
												</span>
												<br>
											</div>
										</div>
									</div>
								</li>
							{% endfor %}
						</ul>
					</div>
				</div>
			</div>
			<div class="col-md-9" style="padding: 0;">
				<div id="schema-diagram"></div>
			</div>
		</div>

	</div>

{% endblock %}
